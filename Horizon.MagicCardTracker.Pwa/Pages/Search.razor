@page "/search/{Query}"
@using Horizon.MagicCardTracker.Pwa.Components
@using Horizon.MagicCardTracker.ScryfallClient
@using Horizon.MagicCardTracker.SrcyfallClient.Extensions
@using CardList = Horizon.MagicCardTracker.Contracts.CardList
@using System.Threading
@inject IScryfallClient _scryfallClient
@implements IDisposable

<div class="row">
    <div class="col-12 lead d-flex justify-content-between">
        <span>Search results</span>
    </div>
</div>

<LoadingIndicator IsBusy=@_isLoading></LoadingIndicator>

@if (!_isLoading)
{
    <CardDisplay Cards="@_searchResult?.Cards">
        <div class="color-white-60 text-center flex-grow-1 d-flex justify-content-center align-items-center lead">
            Phew... Sorry, there was no card that matches your search criteria
        </div>
    </CardDisplay>
}


@code {

    private CancellationTokenSource _cts = new CancellationTokenSource();

    private bool _isLoading;

    private CardList _searchResult;

    [Parameter]
    public string Query { get; set; }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }

    protected override Task OnParametersSetAsync()
    {
        return SearchAsync();
    }

    private async Task SearchAsync()
    {
        _searchResult = null;

        if (string.IsNullOrEmpty(Query))
        {
            return;
        }

        _isLoading = true;

        var query = Query.Replace(" ", "+");

        _searchResult = (await _scryfallClient.SearchCardsAsync(query, true, _cts.Token)).ToContract();
        _isLoading = false;
    }
}
